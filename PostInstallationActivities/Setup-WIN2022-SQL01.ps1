Start-Transcript -Path C:\Windows\Temp\PostInstallation.log -append

$SQLUsername = "sql_admin"
$CurrentDomain = "ad.example.local"

$CurrentFolder = (Split-Path $myInvocation.MyCommand.path -Parent)
$NetBIOSDomainName = $CurrentDomain.Split(".")[0]
$WorkFolder = "$CurrentFolder\$CurrentDomain"
$Users = Import-Csv -Path "$WorkFolder\Users.csv" -Encoding UTF8
$Hostname = [System.Net.Dns]::GetHostName()
$SQLPasword = ($Users | Where-Object { $_.Name -eq $SQLUsername }).Password

# Change ServiceAccount
[System.Reflection.Assembly]::LoadWithPartialName("Microsoft.SqlServer.SqlWmiManagement")
$SMOWmiserver = New-Object("Microsoft.SqlServer.Management.Smo.Wmi.ManagedComputer") $Hostname
$ChangeService = $SMOWmiserver.Services | Where-Object { $_.Name -eq "MSSQLSERVER" }
$ChangeService.SetServiceAccount("$NetBIOSDomainName\$SQLUsername", $SQLPasword)

# Add Domain Users to login object
Copy-Item -Path "$CurrentFolder\scripts\PowerShellModule\SqlServer" -Destination "C:\Program Files\WindowsPowerShell\Modules" -Recurse
powershell.exe -Command "Add-SqlLogin -ServerInstance $Hostname -LoginName 'ad\Domain Users' -LoginType WindowsGroup -GrantConnectSql -Enable"

# powershell.exe -Command "$CurrentFolder\mssql\SQLEXPR_x64_ENU\SETUP.EXE /ConfigurationFile=`"$CurrentFolder\mssql\ConfigurationFile.ini`""

Stop-Transcript
