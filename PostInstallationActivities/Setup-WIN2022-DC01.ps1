Start-Transcript -Path C:\Windows\Temp\PostInstallation.log -append

$CurrentFolder = (Split-Path $myInvocation.MyCommand.path -Parent)
$CurrentDomain = (Get-ADDomain).DNSRoot
$WorkFolder = "$CurrentFolder\$CurrentDomain"
$Users = Import-Csv -Path "$WorkFolder\Users.csv" -Encoding UTF8
$GPOs = Import-Csv -Path "$WorkFolder\GPOs.csv" -Encoding UTF8
$CATemplates = Get-ChildItem -Path "$WorkFolder\CATemplates"

# Add domain users.
foreach ($User in $Users)
{
    $Password = $User.Password | ConvertTo-SecureString -AsPlainText -Force
    New-ADUser -Name $User.Name `
            -AccountPassword $Password `
            -PasswordNeverExpires $true `
            -Enabled $true `
            -Verbose

    if ($User.isAdmin -eq "True")
    {
        Add-ADGroupMember -Identity "Domain Admins" -Members $User.Name
    }
}

# Apply GPOs.
foreach ($GPO in $GPOs)
{
    # Backup-GPO -Name $GPOName -Path "C:\Windows\Temp" -Comment $GPOName
    Import-GPO -CreateIfNeeded -BackupGpoName $GPO.Name -TargetName $GPO.Name -Path "$WorkFolder\GPOs"
    New-GPLink -Name $GPO.Name -Target "DC=ad,DC=example,DC=local"
}

# Register SPN for Kerberoasting.
setspn.exe -S "HTTP/WIN2022-WEB01.ad.example.local" "ad\iis_admin"

# New-ADOrganizationalUnit -Name 'Workstation' -Path "DC=ad,DC=example,DC=local" -Verbose
# Move-ADObject -Identity "CN=WIN11-WS01,CN=Computers,DC=ad,DC=example,DC=local" -TargetPath "OU=Workstation,DC=ad,DC=example,DC=local" -Verbose

# Add vulnerable certificate templates.
Import-Module "$CurrentFolder\scripts\ADCSTemplate.psm1"
# New-ADCSTemplate -DisplayName VulnESC1 -JSON (Get-Content "$WorkFolder\CATemplates\VulnESC1.json" -Raw) -Identity "Domain Users" -Publish

foreach($CATemplate in $CATemplates)
{
    $TemplatePath = $CATemplate.FullName
    $TemplateName = [System.IO.Path]::GetFileNameWithoutExtension($TemplatePath)
    New-ADCSTemplate -DisplayName $TemplateName -JSON (Get-Content $TemplatePath -Raw) -Identity "Domain Users" -Publish
}

Stop-Transcript
