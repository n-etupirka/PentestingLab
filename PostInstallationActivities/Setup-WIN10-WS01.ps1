Start-Transcript -Path C:\Windows\Temp\PostInstallation.log -append

$Username = "service_admin"
$ServiceName = "LoggingApp"
$CurrentDomain = "ad.example.local"

$CurrentFolder = (Split-Path $myInvocation.MyCommand.path -Parent)
$NetBIOSDomainName = $CurrentDomain.Split(".")[0]
$WorkFolder = "$CurrentFolder\$CurrentDomain"
$Users = Import-Csv -Path "$WorkFolder\Users.csv" -Encoding UTF8
$Password = ($Users | Where-Object { $_.Name -eq $Username }).Password

# Set the privileges of the account for executing the service.
Import-Module "$CurrentFolder\scripts\Add-UserRightsPrivilege.ps1"
while ($null -eq $WMIUser)
{
    $WMIUser = Get-WmiObject win32_useraccount -Filter "name = '$Username' AND domain = '$NetBIOSDomainName'"
    if ($null -eq $WMIUser)
    {
        Write-Error "account is not exist."
    }
    Start-Sleep -Seconds 5.0
}

Add-UserRightsPrivilege -SID $WMIUser.SID -Right "SeServiceLogonRight"

# Service registration and startup.
New-Item -Path "C:\" -Name $ServiceName -ItemType "Directory"
Copy-Item -Path "$CurrentFolder\services\$ServiceName.exe" -Destination "C:\$ServiceName"
sc.exe create $ServiceName `
    binPath= "C:\$ServiceName\$ServiceName.exe" `
    DisplayName= $ServiceName `
    start= "auto" `
    obj= "$NetBIOSDomainName\$Username" `
    password= $Password
sc.exe start $ServiceName

Stop-Transcript
