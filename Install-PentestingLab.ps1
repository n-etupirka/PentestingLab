# ----------------------------------------------------------
# Parameters
# ----------------------------------------------------------
Param(
    [Parameter()]
    [switch]
    $EnableInternet
)

# ----------------------------------------------------------
# Global Settings
# ----------------------------------------------------------
# Lab Environment
$LabName = "PentestingLab"
$ServerMemory = 4GB
$ClientMemory = 8GB

# OS Image
$WinSrv2022 = "Windows Server 2022 Standard Evaluation (Desktop Experience)"
$Win10 = "Windows 10 Pro"
$Win11 = "Windows 11 Pro"

# ad.example.local
$DomainName = "ad.example.local"
$DomainAdminUser = "administrator"
$DomainAdminPassword = "admin@123"
$LocalAdminUser = "administrator"
$LocalAdminPassword = "P@ssw0rd"

# ----------------------------------------------------------
# Lab Configuration
# ----------------------------------------------------------
$NetBIOSDomainName = $DomainName.Split(".")[0]
$CurrentFolder = (Split-Path $myInvocation.MyCommand.path -Parent)
$PostInstallationFolder = "$CurrentFolder\PostInstallationActivities"
$Password = ConvertTo-SecureString $LocalAdminPassword -AsPlainText -Force
$LocalAdmin = New-Object System.Management.Automation.PSCredential $LocalAdminUser, $Password

New-LabDefinition -Name $LabName -DefaultVirtualizationEngine HyperV
Add-LabVirtualNetworkDefinition -Name $LabName -AddressSpace 192.168.81.0/24
Set-LabInstallationCredential -Username $DomainAdminUser -Password $DomainAdminPassword
Add-LabDomainDefinition -Name $DomainName -AdminUser $DomainAdminUser -AdminPassword $DomainAdminPassword

# Domain Controller
$SetupWIN2022DC01 = Get-LabPostInstallationActivity `
    -ScriptFileName Setup-WIN2022-DC01.ps1 `
    -DependencyFolder $PostInstallationFolder

# File Server
$SetupWIN2022FS01 = Get-LabPostInstallationActivity `
    -ScriptFileName Setup-WIN2022-FS01.ps1 `
    -DependencyFolder $PostInstallationFolder

# Workstation (Windows 10)
$SetupWIN10WS01 = Get-LabPostInstallationActivity `
    -ScriptFileName Setup-WIN10-WS01.ps1 `
    -DependencyFolder $PostInstallationFolder

# Workstation (Windows 11)
$SetupWIN11WS02 = Get-LabPostInstallationActivity `
    -ScriptFileName Setup-WIN11-WS02.ps1 `
    -DependencyFolder $PostInstallationFolder

# ----------------------------------------------------------
# Lab Install
# ----------------------------------------------------------

# Domain Controller
Add-LabMachineDefinition `
    -Name "WIN2022-DC01" `
    -DomainName $DomainName `
    -Roles RootDC `
    -OperatingSystem $WinSrv2022 `
    -Memory $ServerMemory `
    -IpAddress "192.168.81.4" `
    -PostInstallationActivity $SetupWIN2022DC01

# Certification Authority
Add-LabMachineDefinition `
    -Name "WIN2022-CA01" `
    -DomainName $DomainName `
    -Roles CaRoot `
    -OperatingSystem $WinSrv2022 `
    -IpAddress "192.168.81.5"

# File Server
Add-LabMachineDefinition `
    -Name "WIN2022-FS01" `
    -DomainName $DomainName `
    -Roles FileServer `
    -OperatingSystem $WinSrv2022 `
    -Memory $ServerMemory `
    -IpAddress "192.168.81.6" `
    -PostInstallationActivity $SetupWIN2022FS01

# Workstation (Windows 10)
Add-LabMachineDefinition `
    -Name "WIN10-WS01" `
    -DomainName $DomainName `
    -OperatingSystem $Win10 `
    -Memory $ClientMemory `
    -IpAddress "192.168.81.11" `
    -InstallationUserCredential $LocalAdmin `
    -PostInstallationActivity $SetupWIN10WS01

# Workstation (Windows 11)
Add-LabMachineDefinition `
    -Name "WIN11-WS02" `
    -DomainName $DomainName `
    -OperatingSystem $Win11 `
    -Memory $ClientMemory `
    -IpAddress "192.168.81.12" `
    -InstallationUserCredential $LocalAdmin `
    -PostInstallationActivity $SetupWIN11WS02

Install-Lab

# ----------------------------------------------------------
# Build Lab Environment
# ----------------------------------------------------------
$Password = ConvertTo-SecureString $DomainAdminPassword -AsPlainText -Force
$DomainAdmin = New-Object System.Management.Automation.PSCredential "$NetBIOSDomainName\$DomainAdminUser", $Password

function EnableRDPUser {net.exe localgroup "Remote Desktop Users" "$NetBIOSDomainName\Domain Users" /add}
function CreateFolder
{
    mkdir "C:\works"
    Set-MpPreference -ExclusionPath "C:\works\"
}
function AddDNSForwarder {Add-DnsServerForwarder -IPAddress 192.168.81.3}

# Delete automatically generated files (e.g. unattend.xml) during deployment.
Remove-LabDeploymentFiles

foreach ($Machine in (Get-LabMachineDefinition -All))
{
    $Computer = $Machine.Name

    # Disable AutoLogon if it is enabled.
    if (Test-LabAutoLogon $Computer)
    {
        Disable-LabAutoLogon $Computer
    }

    # Create a working folder.
    Invoke-LabCommand -ActivityName "CreateFolder" `
        -ComputerName $Computer `
        -ScriptBlock {CreateFolder} `
        -Function (Get-Command -Name CreateFolder)

    # Empty Roles is considered a workstation.
    if ([string]::IsNullOrEmpty($Machine.Roles))
    {
        Invoke-LabCommand -ActivityName "EnableRDPUser" `
            -ComputerName $Computer `
            -Credential $DomainAdmin `
            -ScriptBlock {EnableRDPUser} `
            -Variable (Get-Variable -Name NetBIOSDomainName) `
            -Function (Get-Command -Name EnableRDPUser)
    }

    if ($EnableInternet)
    {
        # Configure DNS forwarders.
        if ($Machine.Roles.Name -eq "RootDC")
        {
            Invoke-LabCommand -ActivityName "AddDNSForwarder" `
                -ComputerName $Computer `
                -ScriptBlock {AddDNSForwarder} `
                -Function (Get-Command -Name AddDNSForwarder)
        }
    }
}

# ----------------------------------------------------------
# Setup Complete
# ----------------------------------------------------------
Show-LabDeploymentSummary -Detailed
